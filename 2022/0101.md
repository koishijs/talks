---
theme: seriph
background: http://localhost:8888/69512535_p0.png
class: text-center
highlighter: shiki
---

# Koishi Talk

<div class="opacity-80">
20th / 2022-01-01
</div>

---

# Koishi v4 Release Candidate ğŸ‰

éƒ½è¿‡å»åŠä¸ªæœˆäº†ä½ è¯´å•¥å‘¢ï¼Ÿ

- Backlog Fixes
- Command System
  - Composition
  - Trackability
  - Slash Commands Integration
- Ecosytem
  - OneBot for QQGuild
  - Telegram
  - MySQL 8
- Console Experience
- Documentation

---

# Middleware Updates

- å…è®¸ç›´æ¥è¿”å›å­—ç¬¦ä¸²ä½œä¸ºè¾“å‡ºäº†

```ts
// å¦‚æœæ”¶åˆ°â€œå¤©ç‹ç›–åœ°è™â€ï¼Œå°±å›åº”â€œå®å¡”é•‡æ²³å¦–â€
app.middleware((session, next) => {
  if (session.content === 'å¤©ç‹ç›–åœ°è™') {
    return 'å®å¡”é•‡æ²³å¦–'
  } else {
    return next()
  }
})
```

- `next()` å‡½æ•°ä¹Ÿå…è®¸ç›´æ¥ä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²äº†

```ts
next('fallback content')

// same as
next(() => 'fallback content')

// same as
next(() => session.send('fallback content'))
```

---

# Issue #287

> 1. åœ¨å‘½ä»¤è§£æå®Œæ¯•ï¼Œæ‰€æœ‰ check æ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼Œé¦–ä¸ª action æ–¹æ³•æ‰§è¡Œä¹‹å‰ (äº¦æˆ–æ˜¯åœ¨ check ä¹‹ä¸­)ï¼Œå…è®¸å¼€å‘è€…è¿›è¡Œä¸€äº›ç»Ÿä¸€çš„å¤„ç† (ä¾‹å¦‚ä»æŸä¸ª API è·å–æ•°æ®)ï¼Œç„¶åå°†éœ€è¦çš„å€¼æ”¾å…¥æŸå¤„ (å¦‚ Argv)ï¼Œæ–¹ä¾¿åœ¨ action ä¸­è°ƒç”¨ã€‚
> 2. åœ¨ action å‡½æ•°æ‰§è¡Œæ—¶ï¼Œè‹¥æŠ›å‡ºå¼‚å¸¸ï¼Œå°†è¿›å…¥ä¸€ä¸ªç»Ÿä¸€çš„å¤„ç†å‡½æ•°ã€‚è¯¥å‡½æ•°çš„é¦–ä¸ªå‚æ•°ä¸ºæŠ›å‡ºçš„é”™è¯¯ï¼Œå…¶ä½™å‚æ•°ä¸ action çš„å‚æ•°å®Œå…¨ä¸€è‡´ï¼šå³ç»Ÿä¸€çš„é”™è¯¯å›è°ƒå¤„ç†ï¼Œæ–¹ä¾¿å¼€å‘è€…ç»Ÿä¸€åœ°å¤„ç†è¿è¡Œä¸­é”™è¯¯ï¼Œå¹¶é€šè¿‡è¯¸å¦‚ argv.session.send() ä¹‹ç±»çš„å‡½æ•°å‘ŠçŸ¥ç”¨æˆ·ã€‚

---

# Command Lifecycle

- æŒ‡ä»¤çš„æ‰§è¡Œåˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼šparseï¼Œbeforeï¼Œaction
- before é˜¶æ®µé‡Œä¼šä¾æ¬¡è§¦å‘ `cmd.before()` çš„å›è°ƒå‡½æ•°
  - ä¸€æ—¦æŸä¸ªå›è°ƒå‡½æ•°è¿”å›å­—ç¬¦ä¸²ï¼Œåˆ™ä¼šç«‹å³åœæ­¢åç»­æ‰§è¡Œï¼Œå¹¶ä½œä¸ºæœ¬æ¬¡æ‰§è¡Œçš„è¿”å›å€¼
  - è¿”å›ç©ºä¸²ä¹Ÿå¯ä»¥ä¸­æ­¢åç»­æ“ä½œï¼Œä½†ä¸ä¼šäº§ç”Ÿè¾“å‡º
  - before-command äº‹ä»¶æ˜¯ä¸€ä¸ªå†…ç½®çš„å›è°ƒå‡½æ•°
  - é»˜è®¤æƒ…å†µæ˜¯åæ³¨å†Œå…ˆæ‰§è¡Œï¼Œå¯ä»¥é€šè¿‡äºŒå‚æ•° `append` æ¥ä¿®æ”¹æ­¤è¡Œä¸º
  - ä½¿ç”¨åœºæ™¯ï¼š
    - æ ¸éªŒè¾“å…¥å‚æ•°ï¼Œä¿®æ”¹ Argv å¯¹è±¡
    - æƒé™æ£€æµ‹ï¼Œè§¦å‘é¢‘ç‡æ§åˆ¶
- action é˜¶æ®µé‡Œä¼šä¾æ¬¡è§¦å‘ `cmd.action()` çš„å›è°ƒå‡½æ•°
  - é‡‡ç”¨ä¸ä¸­é—´ä»¶ç±»ä¼¼çš„æ´‹è‘±æ¨¡å‹ï¼Œé€šè¿‡ `argv.next()` è°ƒç”¨åç»­å›è°ƒå‡½æ•°
  - é»˜è®¤æƒ…å†µæ˜¯å…ˆæ³¨å†Œå…ˆæ‰§è¡Œï¼Œå¯ä»¥é€šè¿‡äºŒå‚æ•° `prepend` æ¥ä¿®æ”¹æ­¤è¡Œä¸º
- å¦‚æœæ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯åˆ™ä¼šè§¦å‘ command-error äº‹ä»¶

---

# Examples

```ts
// é”™è¯¯æ•è·
function handleError(cmd: Command) {
  return cmd.action(({ next }, ...args) => {
    return next().catch(() => 'å‘ç”ŸæœªçŸ¥é”™è¯¯')
  }, true)
}
```

```ts
// å‡å¦‚ä½ å…³é—­äº† -h åŠŸèƒ½ï¼Œä½†æƒ³ç»™éƒ¨åˆ†æŒ‡ä»¤æ”¯æŒ -h
function enableHelp(cmd: Command) {
  return cmd
    .option('help', '-h æŸ¥çœ‹å¸®åŠ©')
    .before(({ session, options }) => {
      if (options.help) {
        return session.execute('help', {
          name: 'help',
          args: [cmd.name],
        })
      }
    })
}
```

---

# Chainable Compositions (rc.2)

```ts
import { Command } from 'koishi'

Command.enableHelp(cmd)
Command.handleError(cmd)

ctx.command('foo')
  .use(Command.enableHelp)
  .use(Command.handleError, (error, argv) => {
    if (isNetworkError(error)) return 'é‡åˆ°ç½‘ç»œé—®é¢˜'
    throw error // é»˜è®¤å¤„ç†å‡½æ•°
  })
  .use(Command.handleError)
  .action()
```

---

# Admin Command (rc.2)

<style>

.container {
  display: flex;
  gap: 1rem;
}
.left, .right {
  width: 100%;
}

</style>

<div class="container">
<div class="left">

```ts
// å‡½æ•°åå¾ˆä¸‘ï¼Œæœ‰æ›´å¥½çš„å»ºè®®çš„è¯å¯ä»¥è€ƒè™‘æ¢ä¸€ä¸ª
import { adminUser } from '@koishijs/plugin-admin'
ctx.command('achv [name]')
  // æ·»åŠ  -t, --target é€‰é¡¹ï¼ˆæƒé™ 3ï¼‰
  // æ·»åŠ  argv.user å±æ€§ï¼Œè¡¨ç¤ºç›®æ ‡ç”¨æˆ·
  // è°ƒç”¨è€…æƒé™å¿…é¡»ä¸¥æ ¼é«˜äºç›®æ ‡ç”¨æˆ·
  .use(adminUser)
  // è¿›è¡Œ CRUD æ“ä½œï¼Œæƒé™ 4
  .userFields(['achievements'])
  .option('set', '-s  æ·»åŠ æˆå°±', { authority: 4 })
  .option('unset', '-S  åˆ é™¤æˆå°±', { authority: 4 })
  .action(({ options, user }, name) => {
    if (options.set) {
      user.achievements.push(name)
      return
    } else if (options.unset) {
      // æ²¡æœ‰è¿™ä¸ªæ–¹æ³•æˆ‘çç¼–çš„
      user.achievements.remove(name)
      return
    }
    return user.achievements.join('ï¼Œ')
  })
```

</div>
<div class="right">

ä½¿ç”¨ä¾‹ï¼š

```
achv                        # æŸ¥çœ‹è‡ªå·±çš„æˆå°± (1)
achv -t @xxxx               # æŸ¥çœ‹åˆ«äººçš„æˆå°± (3)

achv -s name                # ä¿®æ”¹è‡ªå·±çš„æˆå°± (4)
achv -t @xxxx -s name       # ä¿®æ”¹åˆ«äººçš„æˆå°± (4)
```

</div>
</div>
